<html>
  <head>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jsrender/0.9.84/jsrender.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/Dynatable/0.3.1/jquery.dynatable.min.js"></script>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/Dynatable/0.3.1/jquery.dynatable.min.css" />
    <script src="//use.fontawesome.com/c938e2358b.js"></script>
    <link rel="stylesheet" href="travis.css" />
  </head>
  <body>
    <div id="header">
      <h1><a href="/">Selenium Travis CI Dashboard</a></h1>
    </div>
    <div id="body">
      <div id="sidebar1" class="sidebar">
        <h2>Builds</h2>
        <ul id="sidebar-builds">
        </ul>
      </div>
      <div id="sidebar2" class="sidebar">
        <h2>Jobs</h2>
        <ul id="sidebar-jobs">
        </ul>
      </div>
      <div id="content">
        <div id="build-info"></div>
        <div id="job-info"></div>
        <div id="tables">
          <table id="table-tests">
            <thead>
            <tr>
              <th>Id</th>
              <th data-dynatable-column="testClass">Test Class</th>
              <th data-dynatable-column="testCase">Test Case</th>
              <th>Result</th>
              <th data-dynatable-column="startedAt">Started At</th>
              <th data-dynatable-column="finishedAt">Finished At</th>
            </tr>
            </thead>
            <tbody>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <script id="build-info-tmpl" type="text/x-jsrender">
      <div id="build-info">
        <span class="result-{{:result}}"></span>
        <span class="info">Build #{{:number}}</span>
        <span class="started">{{:startedAt}}</span>
        <span class="duration">{{:duration}}</span>
      </div>
      <div id="commit-info">
        <span class="branch">{{:branch}}</span>/<span class="commit">{{:commit}}</span>
        <span class="message">{{:commitMessage}}</span> by <span class="author">{{:commitAuthor}}</span>
      </div>
    </script>
    <script id="job-info-tmpl" type="text/x-jsrender">
      <div id="job-info">
        <span class="result-{{:result}}"></span>
        <span class="info">Job #{{:number}}</span>
        <span class="started">{{:startedAt}}</span>
        <span class="duration">{{:duration}}</span>
      </div>
    </script>

    <script>
      var jobTmpl = $.templates("#job-info-tmpl");
      var buildTmpl = $.templates("#build-info-tmpl");

      var queryString = window.location.href.slice(window.location.href.indexOf("?") + 1);
      var jobId = queryString.slice(queryString.indexOf("=") + 1);

      $.getJSON("/rest/job/"+jobId, function(job) {
        var buildId = job["buildId"];

        $("#sidebar-builds").dynatable({
          dataset: { ajax: true, ajaxUrl: '/rest/builds', ajaxOnLoad: true, records: [] },
          writers: { _rowWriter: function(rowIndex, record) {
              var html = '<li '+(record["id"] == buildId ? 'class="active"' : "")+'>';
              html += '<a href="/build.html?id='+record["id"]+'">';
              if (record["result"] == 0) {
                html += '<i class="fa fa-check" aria-hidden="true"></i>'
              } else if (record["result"] == 1) {
                html += '<i class="fa fa-times" aria-hidden="true"></i>'
              } else if (record["result"] == 2) {
                html += '<i class="fa fa-spinner fa-spin" aria-hidden="true"></i>'
              }
              html += record["number"] + '</a></li>';
              return html;
          }},
          features: { paginate: false, sort: false, search: false, recordCount: false }
        });

        $("#sidebar-jobs").dynatable({
          dataset: { ajax: true, ajaxUrl: "/rest/jobs/"+buildId, ajaxOnLoad: true, records: [] },
          writers: { _rowWriter: function(rowIndex, record) {
            var html = '<li '+(record["id"] == jobId ? 'class="active"' : "")+'>';
            html += '<a href="/job.html?id='+record["id"]+'">';
            if (record["result"] == 0) {
              html += '<i class="fa fa-check" aria-hidden="true"></i>'
            } else if (record["result"] == 1) {
              html += '<i class="fa fa-times" aria-hidden="true"></i>'
            } else if (record["result"] == 2) {
              html += '<i class="fa fa-spinner fa-spin" aria-hidden="true"></i>'
            }
            html += record["number"] + '</a></li>';
            return html;
          }},
          features: { paginate: false, sort: false, search: false, recordCount: false }
        });

        $.getJSON("/rest/build/"+buildId, function(build) {
          $("#build-info").html(buildTmpl.render(build));
        });

        $("#job-info").html(jobTmpl.render(job));
      });

      $("#table-tests").dynatable({
        dataset: { ajax: true, ajaxUrl: "/rest/tests/"+jobId, ajaxOnLoad: true, records: [] },
        features: { paginate: false, search: false, recordCount: false }
      });
      $("#table-tests").dynatable().on("click", "tbody tr", function() {
        window.location = "test.html?id=" + $(this).find("td").first().text();
      });
    </script>
  </body>
</html>
